# PinplayCache

These tools use the Pinplay framework and Matlab to analyze hot spots in a data cache for a given program. The pinplay files 
model a cache and record the number of data accesses at each address at set instruction intervals as a program is replayed. 
The resulting csv file can be visualized using the provided Matlab script, which produces a graph of the hot addresses 
within each instruction interval over the execution of the program.

To use these tools, carry out the following steps:
1. Download and install Pinplay from https://software.intel.com/en-us/articles/program-recordreplay-toolkit

2. Add the path for the root directory of Pin to the shell environment as PIN_ROOT:
  export PIN_ROOT=<path to Pin directory>
  Add the path to the scripts directory of Pin to the PATH variable:
  export PATH=$PATH:<path to Pin directory>/extras/pinplay/scripts

3. Replace the dcache.H and dcache.cpp files in the extras/pinplay/examples directory with the corresponding files in this 
repository. To change the instruction count interval for how large of a section to collect accesses over, update the 
INSTR_COUNT_INTERVAL value defined in the global variables section of dcache.cpp.

4. As root, run the following command: echo 0 > /proc/sys/kernel/yama/ptrace_scope

5. In the examples directory, run make to build the executables.

6. After generating or downloading pinballs for a program, execute the following command:
replay.py --pintool=<path to Pin dir>/extras/pinplay/bin/intel64/dcache.so <path to pinball>

7. Two files should be generated by this: dcache.out and dcachecsv.out. The first contains information about the number of 
stores and loads and the number of hits and misses for each. dcachecsv.out contains the data access numbers for each address
at each interval. This file is formatted in the following way:
Row 1: the instruction count at the end of each interval, separated by commas
Rows 3 - eof: address (in base 10), followed by the number of accesses at the address within each interval, separated by
commas
Note: the two file names can be specified to something other than dcache.out and dcachecsv.out using the commandline switches
-o for the first and -csv for the second.

8. To generate the graph of the data accesses, open dcacheToPlot.m in Matlab. Edit the filename and filedir to the name of 
the csv file and the path to directory it is located in. Edit the figurename to the desired name of the image file. It will
be written in the same directory as the csv file. Edit the cutoff point as desired. The cutoff is calculated by taking the 
provided cutoff point and multiplying it by the maximum number of accesses for any interval in the file. So, a cutoff point
of 0.01 means that the cutoff will be 1% of the maximum number of accesses. Any addresses that have accesses above that will
be included in the final data, and addresses for which all intervals have accesses below that threshold will be removed.

9. Run the script in Matlab. This script reads the csv file into a matrix. It removes the address and instruction count data 
and stores that for use in the graph labeling. It then trims out any addresses for which there is no interval where the 
number of accesses meets or exceeds the cutoff point. Finally, it prints the matrix with labels and a color coded mapping
that illuminates which addresses are hot in each instruction interval. This figure is saved to the provided file name.
